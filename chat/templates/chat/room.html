{% extends 'home/header.html' %}
{% load static %}

{% block inhead %}
    <style>

        .admin-message {
            position: absolute;
            background: darkorange !important;
            box-shadow: 0 0 10px 5px rgba(255, 100, 0, 0.5),
            0 0 10px 5px rgba(255, 255, 0, 0.3),
            0 0 10px 5px rgba(0, 255, 0, 0.2) !important;
        }

        .svg {
            filter: invert(100%);
        }

        textarea {
            resize: none;
            overflow: hidden;
        }
    </style>
{% endblock %}

{% block title %}
    Чат комната
{% endblock %}



{% block nav_bar %}
    {% include 'home/nav-bar.html' %}

    {% if personal_message %}
        <h5>Закрытая беседа {{ users }}</h5>
    {% else %}
        <div class="container" id="room-name-container">
            <span class="h5 list-inline-item me-0">Добро пожаловать в комнату "</span>
            <a class="h5 list-inline-item me-0" data-bs-toggle="dropdown" id='room-name'
               aria-expanded="false" href="#">{{ room_name }}</a>
            <ul class="dropdown-menu" id="room-menu">
                <li><a class="btn dropdown-item" href="#" onclick="showRenameRoom()">
                    <img class="svg" src="{% static "svg/edit.svg" %}" alt="rename_room">
                    <div class="vr mx-2"></div>
                    Переименовать</a></li>
                <li><a class="btn dropdown-item disabled" href="#">
                    <img class="svg" src="{% static "svg/users.svg" %}" alt="users_in_room">
                    <div class="vr mx-2"></div>
                    Пользователи</a></li>
            </ul>
            <span class="h5 list-inline-item">"!</span>
            <form id="renameChatRoomForm" method="GET" class="visually-hidden">
                {% csrf_token %}
                <div class="input-group mt-1">
                    <input type="text" name="room-name" id="room-name-input" autofocus
                           placeholder="Введите новое имя чата"
                           class="form-control active border-primary focus-ring" aria-label="Введите новое имя чата"
                           pattern="[а-яёА-ЯЁa-zA-Z0-9\s]+" title="Спецсимволы в названии комнаты запрещены"
                           aria-describedby="room-name-submit" maxlength="100" required>
                    <button class="btn btn-primary" type="submit" id="room-name-submit">Переименовать</button>
                    <button class="btn btn-danger" type="button" id="room-name-cancel" onclick="hideRenameRoom()">
                        Отмена
                    </button>
                </div>
            </form>
        </div>
    {% endif %}

{% endblock %}
{% block body_block %}
    <div class="container position-relative">
        <div class="row align-items-end overflow-y-auto mb-5" id="content-place">
            <div class="col mb-1 vstack align-self-end" id="chat-log">
            </div>
            <div class="col card-text placeholder-glow vstack align-self-end gap-3 my-1 me-3" id="placeholder">
                <div class="placeholder col-7 bg-primary"></div>
                <div class="placeholder col-4 bg-primary"></div>
                <div class="row">
                    <div class="placeholder offset-8 col-4 bg-success"></div>
                </div>
                <div class="placeholder col-6 bg-primary"></div>
                <div class="row">
                    <div class="placeholder offset-4 col-8 bg-success"></div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}
{% block footer %}
    <div class="fixed-bottom z-1">
        <div>
            <div class="btn mx-auto visually-hidden user-select-none" href="#" data-bs-toggle="dropdown"
                 aria-expanded="false">Сообщение
            </div>
            <ul class="dropdown-menu message-menu">
                <li>
                    <a class="dropdown-item disabled" onclick="replyToMessageFromBtn(this)">
                        <img class="svg" src="{% static "svg/reply.svg" %}" alt="reply">
                        <div class="vr  mx-2"></div>
                        Ответить</a>
                </li>
                <li>
                    <a class="dropdown-item" onclick="copyMessageFromBtn(this)">
                        <img class="svg" src="{% static "svg/copy.svg" %}" alt="copy">
                        <div class="vr mx-2"></div>
                        Копировать</a>
                </li>
                <li>
                    <a class="dropdown-item visually-hidden" onclick="forwardMessageFromBtn(this)">
                        <img class="svg" src="{% static "svg/forward.svg" %}" alt="forward">
                        <div class="vr mx-2"></div>
                        Переслать</a>
                </li>
                <li>
                    <a class="dropdown-item disabled" onclick="pinMessageFromBtn(this)">
                        <img class="svg" src="{% static "svg/pin.svg" %}" width="24px" height="24px" alt="pin">
                        <div class="vr mx-2"></div>
                        Закрепить</a>
                </li>
                <li>
                    <a class="dropdown-item " onclick="editMessageFromBtn(this)">
                        <img class="svg" src="{% static "svg/edit.svg" %}" alt="edit">
                        <div class="vr  mx-2"></div>
                        Изменить</a>
                </li>
                <li>
                    <a class="dropdown-item" onclick="deleteMessageFromBtn(this)">
                        <img class="svg" src="{% static "svg/trash-2.svg" %}" alt="delete">
                        <div class="vr mx-2"></div>
                        Удалить</a>
                </li>
            </ul>
        </div>

        <div class="container  py-3 bg-dark">
            <form id="sendMessageForm">
                {% csrf_token %}
                <div class="input-group">
                    <textarea type="text" name="chat-message-input" id="chat-message-input" autofocus
                              placeholder="Введите сообщение"
                              class="form-control active border-primary focus-ring overflow-y-auto"
                              aria-label="Введите сообщение"
                              aria-describedby="chat-message-submit" maxlength="500" required rows="1"
                              style="max-height: 150px;"></textarea>
                    <button class="btn btn-primary" type="submit" id="chat-message-submit">
                        <img class="svg" src="{% static "svg/send.svg" %}" alt="send">
                    </button>
                </div>
            </form>

            <form id="editMessageForm" class="visually-hidden">
                {% csrf_token %}
                <div class="d-flex">
                    <div class="m-2"><img class="svg" src="{% static "svg/edit-3.svg" %}" alt="send"></div>
                    <div class="vstack col-8 mx-2" id="editedMessage">
                        <div id="editedMessageSender" class="text-primary">Имя</div>
                        <div id="editedMessageText" class="text-truncate">Текст</div>
                    </div>
                    <div class="m-2 btn" onclick="closeEdit()"><img class="svg" src="{% static "svg/x.svg" %}"
                                                                    alt="send"></div>
                </div>
                <div class="input-group">
                    <textarea type="text" name="chat-message-edit-input" id="chat-message-edit-input" autofocus
                              placeholder="Введите сообщение"
                              class="form-control active border-primary focus-ring overflow-y-auto"
                              aria-label="Введите сообщение"
                              aria-describedby="chat-message-edit-submit" maxlength="500" required rows="1"
                              style="max-height: 150px;"></textarea>
                    <input class="visually-hidden" id="chatMessageIDInput">
                    <button class="btn btn-primary" type="submit" id="chat-message-edit-submit">
                        <img class="svg" src="{% static "svg/check.svg" %}" alt="send">
                    </button>
                </div>
            </form>
        </div>
        {% include 'home/footer.html' %}
    </div>

    <script src="{% static "js/local-date.js" %}?v1.1"></script>
    <script>
        const chatMessageInput = document.querySelector('#chat-message-input');
        const chatMessageEditInput = document.querySelector('#chat-message-edit-input');
        const chatLog = document.querySelector('#chat-log');
        const chatMessageSubmitBtn = document.querySelector('#chat-message-submit');
        const chatMessageEditSubmitBtn = document.querySelector('#chat-message-edit-submit');


        function isMobileDevice() {
            return (typeof window.orientation !== 'undefined') || (navigator.userAgent.indexOf('IEMobile') !== -1 || (window.innerWidth < 770))
        }

        if (isMobileDevice()) {
            chatMessageInput.addEventListener('focus', setChatHeight);
            chatMessageInput.addEventListener('blur', setChatHeight);
        } else {
            addEnterListener(chatMessageInput);
            addEnterListener(chatMessageEditInput);
        }

        addEnterListener(document.getElementById('room-name-input'));

        function addEnterListener(element) {
            element.addEventListener('keydown', function (event) {
                if (event.key === 'Enter' && !event.shiftKey) {
                    event.preventDefault(); // Отменить перевод строки
                    getNextBtn(element).click(); // Имитировать клик по кнопке submit
                }
            });
        }

        function getNextBtn(element) {
            while (element !== null) {
                element = element.nextElementSibling;
                if (element.classList.contains('btn')) return element
            }
        }

        function setChatHeight() {
            const chatHeight = chatMessageInput.getBoundingClientRect().top - document.querySelector('#room-name-container').getBoundingClientRect().bottom - 20;
            document.querySelector('#content-place').style.height = chatHeight + "px";

        }

        window.addEventListener('load', function () {
            setChatHeight();
        });
        window.addEventListener('resize', function () {
            setChatHeight();
        });

        addAutoHeightInputListener(chatMessageInput);
        addAutoHeightInputListener(chatMessageEditInput);

        function addAutoHeightInputListener(element) {
            element.addEventListener('input', function () {
                textareaAutoHeight(this)
            });
        }

        function textareaAutoHeight(element) {
            element.style.height = 'auto';
            element.style.height = `${element.scrollHeight}px`;
            setChatHeight();
        }

        const room_pk = "{{ room.pk }}";
        const request_id = "{{ session_key }}";
        const current_user = "{{ user.get_username }}"
        const current_user_is_superuser = "{{ user.is_superuser }}"
        let lastMessage;
        let lastDate;
        let lastTime;
        let chatSocket = new WebSocket(webSocket());

        chatSocket.onopen = function () {
            chatSocket.send(
                JSON.stringify({
                    pk: room_pk,
                    action: "join_room",
                    request_id: request_id,
                })
            );
            chatSocket.send(
                JSON.stringify({
                    pk: room_pk,
                    action: "retrieve",
                    request_id: request_id,
                })
            );
            chatSocket.send(
                JSON.stringify({
                    pk: room_pk,
                    action: "subscribe_to_messages_in_room",
                    request_id: request_id,
                })
            );
            chatSocket.send(
                JSON.stringify({
                    pk: room_pk,
                    action: "subscribe_instance",
                    request_id: request_id,
                })
            );
        };

        chatSocket.onmessage = function (e) {
            const data = JSON.parse(e.data);
            console.log('RealTime', data)
            switch (data.action) {
                case "retrieve":
                    document.querySelector('#placeholder').remove();
                    for (let message of data.data.messages) {
                        createNewMessage(message);
                    }
                    break;
                case "create":
                    createNewMessage(data.data);
                    break;
                case "delete":
                    document.querySelector('#message_' + data.pk).remove();
                    break;
                case "update":
                    if (data.errors) {
                        alert(data.errors[0]);
                    } else {
                        if (data.data.name) {
                            document.getElementById('room-name').innerHTML = data.data.name
                        } else updateMessage(data.data);
                    }
                    break;
                default:
                    break;
            }
        };

        function createNewMessage(data) {
            let sender;
            let divClass;
            let position = 'mt-1 ';
            let time;
            if (data.created_at) {
                const date = localeDate(data.created_at);
                time = localeTime(data.created_at);
                if (lastDate !== date) {
                    lastDate = date
                    systemMessage(date);
                }
                if (lastTime !== time) {
                    lastTime = time
                }
                if (lastMessage && isLongTime(lastMessage.created_at, data.created_at)) {
                    position = "mt-3 "
                }
            }
            if (!lastMessage || lastMessage.id < data.id) {

                if (lastMessage && lastMessage.user.username !== data.user.username) {
                    position = "mt-3 "
                }
                if (data.user.username === current_user) {
                    sender = "Вы";
                    divClass = "bg-success rounded-start-4";
                    position += "justify-content-end ";
                } else {
                    sender = data.user.username;
                    divClass = "bg-primary rounded-end-4";
                    position += "justify-content-start ";
                }
                if (data.user.is_superuser) divClass += " admin-message"
                const edited = data.is_edited ? "изменено" : "";
                chatLog.innerHTML += `<div class="d-flex ${position}" id="message_${data.id}">` +
                    `<div class= 'position-relative rounded-top-4 ${divClass}' href="#" onclick="addMenuAtMessage(this)" ` +
                    `data-bs-toggle="dropdown" aria-expanded="true"><div class='text-break  text-white  px-2' >(<em>` +
                    sender + `</em>): <em>` + escapingMessageSpecialCharacters(data.text) +
                    `</em> <em class= "badge fw-light text-wrap" style="width: 5rem;">${edited}</em>&nbsp;&nbsp; &nbsp; &nbsp;</div> ` +
                    `<em class= "position-absolute bottom-0 end-0 badge fw-light text-wrap pe-0 pb-1" style="width: 3rem;">` +
                    `${time}</em></div><ul class="dropdown-menu user-select-none"></ul></div>`;

                chatLog.parentNode.scrollTop = chatLog.parentNode.scrollHeight;
                lastMessage = data;
            }
        }

        function updateMessage(data) {
            const message = document.getElementById('message_' + data.id);
            if (message) {
                const messageEms = message.querySelectorAll('em');
                messageEms[1].innerHTML = escapingMessageSpecialCharacters(data.text);
                messageEms[2].innerHTML = "изменено";
            }
        }

        function addMenuAtMessage(element) {
            const menu = element.nextElementSibling;
            const dropdown = new bootstrap.Dropdown(element)
            dropdown.toggle()
            if (element.querySelector('em').innerText === "Вы" || current_user_is_superuser) {
                menu.innerHTML = document.querySelector('.message-menu').innerHTML;
            } else {

                menu.innerHTML = "";
                const menuChild = document.querySelector('.message-menu').children
                for (let i = 0; i < 4; i++) {
                    menu.appendChild(menuChild[i].cloneNode(true));
                }
            }
            dropdown.toggle()
            menu.scrollIntoView({behavior: "smooth"});
        }


        function escapingMessageSpecialCharacters(text) {
            return text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/\n/g, '<br>')
        }

        chatSocket.onclose = function () {
            systemMessage("Соединение разорвано, пожалуйста обновите страницу!")
            chatSocket = new WebSocket(webSocket());
        };

        function systemMessage(message) {
            chatLog.innerHTML += `<div class="my-3 d-flex justify-content-center">` +
                `<div class= 'rounded-4 text-white bg-secondary text-center mx-auto py-0 px-2' >` +
                message + `</div></div>`;
            chatLog.parentNode.scrollTop = chatLog.parentNode.scrollHeight;
        }

        //Отправить сообщение
        document.getElementById("sendMessageForm").addEventListener("submit", function (event) {
            event.preventDefault();
            const message = chatMessageInput.value;
            chatSocket.send(JSON.stringify({
                message: message,
                action: "create_message",
                request_id: request_id,
            }));
            chatMessageInput.value = '';
            chatMessageInput.focus()
        });

        //Отредактировать сообщение
        document.getElementById("editMessageForm").addEventListener("submit", function (event) {
            event.preventDefault();
            editMessage(document.getElementById('chatMessageIDInput').value, chatMessageEditInput.value)
            closeEdit()
        });

        //Переименовывание комнаты
        const renameForm = document.getElementById("renameChatRoomForm");
        renameForm.addEventListener("submit", function (event) {
            event.preventDefault();
            renameRoom(document.getElementById('room-name-input').value.replace(/[^а-яёА-ЯЁa-zA-Z\d\s]/g, ''));
            hideRenameRoom()
        });

        function showRenameRoom() {
            renameForm.classList.remove('visually-hidden');
            setChatHeight();
            document.getElementById('room-name-input').focus()
        }

        function hideRenameRoom() {
            renameForm.classList.add('visually-hidden');
            setChatHeight();
            chatMessageInput.focus()
        }

        function renameRoom(room_name) {
            chatSocket.send(JSON.stringify({
                room_name: room_name,
                action: "rename_room",
                request_id: request_id,
            }));
        }

        function closeEdit() {
            chatMessageEditInput.value = '';
            document.getElementById('editMessageForm').classList.add('visually-hidden');
            document.getElementById('sendMessageForm').classList.remove('visually-hidden');
            setChatHeight();
            chatMessageInput.focus();
        }

        function getMessageText(messageElement) {
            const text = messageElement.querySelectorAll('em')[1].innerText;
            return text.replace(/<br>/g, '\n').replace(/&gt;/g, '>').replace(/&lt;/g, '<').replace(/&amp;/g, '&');
        }

        function replyToMessageFromBtn(btn) {
            const messageElement = btn.parentNode.parentNode.parentNode
            console.log(getMessageID(messageElement) + " " + messageElement.querySelectorAll('em')[1].innerText)
        }

        function copyMessageFromBtn(btn) {
            navigator.clipboard.writeText(getMessageText(btn.parentNode.parentNode.parentNode))
                .then(function () {
                    console.log("Текст скопирован в буфер обмена");
                })
                .catch(function (error) {
                    console.error("Не удалось скопировать текст: ", error);
                });
        }

        function forwardMessageFromBtn(btn) {
            const messageElement = btn.parentNode.parentNode.parentNode
            console.log(getMessageID(messageElement) + " " + messageElement.querySelectorAll('em')[1].innerText)
        }

        function pinMessageFromBtn(btn) {
            const messageElement = btn.parentNode.parentNode.parentNode
            console.log(getMessageID(messageElement) + " " + messageElement.querySelectorAll('em')[1].innerText)
        }

        function deleteMessageFromBtn(btn) {
            const messageElement = btn.parentNode.parentNode.parentNode
            deleteMessage(getMessageID(messageElement))
            messageElement.classList.add("visually-hidden")
        }


        function editMessageFromBtn(btn) {
            const messageElement = btn.parentNode.parentNode.parentNode
            document.getElementById('editMessageForm').classList.remove('visually-hidden');
            document.getElementById('sendMessageForm').classList.add('visually-hidden');
            chatMessageEditInput.value = getMessageText(messageElement);
            const messageID = getMessageID(messageElement);
            const messageEms = messageElement.querySelectorAll('em')
            document.getElementById('chatMessageIDInput').value = messageID;
            document.getElementById('editedMessageSender').innerHTML = messageEms[0].innerText;
            document.getElementById('editedMessageText').innerHTML = messageEms[1].innerText;
            document.getElementById('editedMessage').onclick = () => focusMessageById(messageID);
            textareaAutoHeight(chatMessageEditInput)
        }


        function focusMessageById(messageID) {
            document.getElementById('message_' + messageID).scrollIntoView({behavior: 'smooth'});
        }

        function getMessageID(messageElement) {
            return parseInt(messageElement.id.substring(8))
        }

        function deleteMessage(message_id) {
            chatSocket.send(JSON.stringify({
                message_id: message_id,
                action: "delete_message",
                request_id: request_id,
            }));
        }

        function editMessage(message_id, text) {
            chatSocket.send(JSON.stringify({
                message_id: message_id,
                text: text,
                action: "edit_message",
                request_id: request_id,
            }));
        }

        function update_current_users() {
            chatSocket.send(JSON.stringify({
                action: "update_current_users",
                request_id: request_id,
            }));
        }

        function webSocket() {
            const protocol = window.location.protocol === "http:" ? 'ws://' : 'wss://';
            return protocol + window.location.host + '/ws/chat/'
        }

        function isLongTime(date_str1, date_str2) {
            const diffInMinutes = Math.abs(new Date(date_str2) - new Date(date_str1)) / (1000 * 60);
            return (diffInMinutes > 10)
        }

        </script>


{% endblock %}
