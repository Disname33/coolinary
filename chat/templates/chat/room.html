{% extends 'home/header.html' %}
{% load static %}

{% block inhead %}

{% endblock %}

{% block title %}
    Чат комната
{% endblock %}

{% block body_block %}
    {% if alien %}
        {% include "modules/modal.html" %}
        <script>
            const modalBackdrop = document.getElementById('staticBackdrop');
            const options = {
                backdrop: 'static',
                keyboard: false
            };
            const modal = new bootstrap.Modal(modalBackdrop);
            const modalBtn = modalBackdrop.querySelector('.btn');
            modalBackdrop.querySelector('#staticBackdropLabel').textContent = 'Это закрытый чат';
            modalBackdrop.querySelector('.modal-body').textContent = "У Вас нет доступа к этому чату!";
            modalBtn.classList.add("btn-secondary");
            modalBtn.innerHTML = "Назад";
            modal.show(options);

            function closeModalAndRestart() {
                closeModal();
            }

            function closeModal() {
                history.back();
                modal.show(options);
            }
        </script>
    {% else %}
        <div class="container">
            {% if personal_message %}
                <h5>Закрытая беседа {{ users }}</h5>
            {% else %}
                <h5>Добро пожаловать в комнату "{{ room_name }}"!</h5>
            {% endif %}
            <div class="row align-items-end overflow-y-auto" style="min-height: 60vh; max-height: 65vh">
                <div class="col mb-3 vstack align-self-end" id="chat-log">
                </div>
            </div>
            <form id="sendMessageForm">
                {% csrf_token %}
                <div class="input-group mb-3">
                    <input type="text" name="chat-message-input" id="chat-message-input" autofocus
                           placeholder="Введите сообщение"
                           class="form-control active border-primary focus-ring" aria-label="Введите сообщение"
                           aria-describedby="chat-message-submit" maxlength="255" required>
                    <button class="btn btn-primary btn-lg" type="submit" id="chat-message-submit">Отправить</button>
                </div>
            </form>
        </div>
        <script src="{% static "js/local-date.js" %}?v1.1"></script>
        <script>
            const chatMessageInput = document.querySelector('#chat-message-input');
            const chatLog = document.querySelector('#chat-log');
            const room_pk = "{{ room.pk }}";
            const request_id = "{{ session_key }}";
            let lastMessage;
            let lastDate;
            let lastTime;
            console.log("room_pk", room_pk)
            console.log("request_id", request_id)
            const chatSocket = new WebSocket(webSocket());

            chatSocket.onopen = function () {
                chatSocket.send(
                    JSON.stringify({
                        pk: room_pk,
                        action: "join_room",
                        request_id: request_id,
                    })
                );
                chatSocket.send(
                    JSON.stringify({
                        pk: room_pk,
                        action: "retrieve",
                        request_id: request_id,
                    })
                );
                chatSocket.send(
                    JSON.stringify({
                        pk: room_pk,
                        action: "subscribe_to_messages_in_room",
                        request_id: request_id,
                    })
                );
                chatSocket.send(
                    JSON.stringify({
                        pk: room_pk,
                        action: "subscribe_instance",
                        request_id: request_id,
                    })
                );
            };

            chatSocket.onmessage = function (e) {
                const data = JSON.parse(e.data);
                console.log('RealTime', data)
                switch (data.action) {
                    case "retrieve":
                        for (let message of data.data.messages) {
                            createNewMessage(message);
                        }
                        break;
                    case "create":
                        createNewMessage(data.data);
                        break;
                    default:
                        break;
                }
            };

            function createNewMessage(data) {
                let sender;
                let divClass;
                let position = 'mt-1 ';
                let time;
                if (data.created_at) {
                    const date = localeDate(data.created_at);
                    time = localeTime(data.created_at);
                    if (lastDate !== date) {
                        lastDate = date
                        systemMessage(date);
                    }
                    if (lastTime !== time) {
                        lastTime = time
                    }
                    if (lastMessage && isLongTime(lastMessage.created_at, data.created_at)) {
                        position = "mt-3 "
                    }
                }
                if (data.sender === "Системное сообщение") {
                    systemMessage(data.text)
                } else {
                    if (lastMessage && lastMessage.user.username !== data.user.username) {
                        position = "mt-3 "
                    }
                    if (data.user.username === "{{ user.get_username }}") {
                        sender = "(Вы): ";
                        divClass = "bg-success rounded-start-4";
                        position += "justify-content-end ";

                    } else {
                        sender = "(" + data.user.username + "): ";
                        divClass = "bg-primary rounded-end-4";
                        position += "justify-content-start ";
                    }
                    chatLog.innerHTML += `<div class="d-flex ` + position + `" id="message_` + data.id +
                        `"><div class= 'position-relative text-break rounded-top-4 text-white ` +
                        divClass + ` px-2' >` + sender + data.text + `&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;` +
                        `<span class= "position-absolute bottom-0 end-0 badge fw-light text-wrap pe-0 pb-1" style="width: 3rem;">`
                        + time + `</span></div></div>`;
                    chatLog.parentNode.scrollTop = chatLog.parentNode.scrollHeight;
                    lastMessage = data;
                }

            }

            chatSocket.onclose = function () {
                systemMessage("Соединение разорвано, пожалуйста обновите страницу!")
            };

            function systemMessage(message) {
                chatLog.innerHTML += `<div class="my-3 d-flex justify-content-center">` +
                    `<div class= 'rounded-4 text-white bg-secondary text-center mx-auto py-0 px-2' >` +
                    message + `</div></div>`;
                chatLog.parentNode.scrollTop = chatLog.parentNode.scrollHeight;
            }

            document.getElementById("sendMessageForm").addEventListener("submit", function (event) {
                event.preventDefault();
                const message = chatMessageInput.value;
                chatSocket.send(JSON.stringify({
                    message: message,
                    action: "create_message",
                    request_id: request_id,
                }));
                chatMessageInput.value = '';
                chatMessageInput.focus()
            });


            function webSocket() {
                const protocol = window.location.protocol === "http:" ? 'ws://' : 'wss://';
                return protocol + window.location.host + '/ws/chat/'
            }

            function isLongTime(date_str1, date_str2) {
                const diffInMinutes = Math.abs(new Date(date_str2) - new Date(date_str1)) / (1000 * 60);
                return (diffInMinutes > 10)
            }
        </script>

    {% endif %}
{% endblock %}
